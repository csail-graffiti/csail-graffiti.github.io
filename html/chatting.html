<h1>
  Chatting
</h1>

<p>
  The page describes some basic primitives that you could combine to make a broad range of chat applications.
  To get started, download the <a href="./graffiti-template.html" download>Graffiti template</a> to have a base to work off of.
</p>

<p>
  First, you'll need to put a log in button somewhere in your app, as described in
  <RouterLink to="/logging-in">§Logging In</RouterLink>.
  For example:
</p>

<GraffitiPlayground path="log-in" />

<h2>
  Your Actor ID
</h2>

<p>
  When you log in to Graffiti, you are assigned an "actor" ID.
  This a unique ID that represents you,
  and in the chat app you can think of it kind of like an email address.
</p>

<p>
  Your actor ID is shown below, we've just wrapped it in an <code class="language-html">&lt;input></code> to make it easier to copy.
  As you can see it's pretty ugly, so in your actual app you probably don't want to expose it to the user.
  However, for the sake of simplifying the demos in this section we're going to be manually copying and pasting it where needed.
</p>

<GraffitiPlayground path="actor" />

<h2>
  Sending a Message
</h2>

<p>
  There are two main steps to getting a chat app to work: sending and receiving messages.
  Messages in Graffiti are just JSON objects. To send a message, you
  need to construct a JSON object full of all the information
  you want in your message and then pass it to the <code class="language-js">$graffitiUpdate</code> function
  to add the message to the Graffiti database.
</p>

<p>
  There is a lot of flexibility for you to add custom properties to your JSON objects,
  but it's best to use commonly understood properties
  when possible so that your app will interoperate with other chat apps.
  We're going to make our message look like an ActivityStreams <a href="https://www.w3.org/TR/activitystreams-vocabulary/#dfn-note">Note</a> type which is used for short pieces of text, like messages or tweets.
  All this means is that we need to assign the
  <code class="language-js">type</code> property of the JSON object to <code class="language-js">'Note'</code>
  and assign the <code class="language-js">content</code> property of the object to the message text we want to send.
</p>

<p>
  We're also going to use the <code class="language-js">bto</code> property ("blind to")
  to make our message <RouterLink to="/privacy">private</RouterLink>: only readable by a specific array of recipients.
  In the example below we're only going to send a message to a single recipient,
  but for group messages you just add more recipients to the array.
</p>

<p>
  Finally, we're going put the message in the "context" of the sender's and receiver's actor IDs.
  You can read more about context in the <RouterLink to="/context">guide</RouterLink>,
  but in this case you can think of it as placing the message in both "the sender's outbox" and "the recipient's inbox".
</p>

<p>
  Putting this altogether, you can try sending a message below.
  You can use a friend's actor ID or you can use your own and send a message to yourself.
  Unfortunately, you won't be able to see any messages you sent yet... read on! :)
</p>

<GraffitiPlayground path="send-message" :data="{messageContent:'',recipient:''}" />

<h2>
  Receiving Message
</h2>

<p>
  Graffiti is designed to be used by many applications at once,
  so when you receive messages, you need to filter out all of the messages that aren't relevant to your current use case.
  In our chat app, we want the messages we receive to look like the messages we've sent.
</p>

<p>
  There are several ways to filter for messages, as described in <RouterLink to="/object-basics">§Object Basics</RouterLink>,
  but the way we recommend is to use JSON schema.
  You can read more about it in the <a href="https://json-schema.org/learn/getting-started-step-by-step.html">JSON schema tutorial</a>, but you might be able to pick the basics up just by pattern matching.
  Translating to English, the schema below says:
</p>

<blockquote>
  The <code class="language-js">type</code>, <code class="language-js">bto</code>, and <code class="language-js">content</code> properties must exist.
  The object's <code class="language-js">type</code> property must be equal to <code class="language-js">'Note'</code>.
  The object's <code class="language-js">content</code> property must be a string.
  The object's <code class="language-js">bto</code> property must be an array of exactly length 1, containing my actor ID.
  The object's <code class="language-js">actor</code> property must be equal to the recipient's actor ID.
</blockquote>

<p>
  Finally, we're assigning the filtered objects to the variable <code class="language-js">messages</code> using <code class="language-js">v-slot</code> and sorting the objects in reverse order by <code class="language-js">published</code>, putting the most recent messages first.
  Try it out:
</p>

<GraffitiPlayground path="receive-message" :data="{recipient:''}" />

<p>
  The code above describes your "inbox" but it is almost no different than the code to describe your "outbox".
  Try modifying the code above so that it filters for objects <em>from</em> you and <em>to</em> the recipient.
</p>

<h2>
  Getting a Message by ID
</h2>

<p>
  You can also retrieve a message directly by it's ID.
  Modify the code above to display <code class="language-js">message.id</code> rather than <code class="language-js">message.content</code>, 
  then paste that ID to view the message below.
  This can be used to "link" to messages.
</p>

<GraffitiPlayground path="graffiti-object" :data="{id: ''}"/>

<p>
  You should now be able to see all the properties associated with the object.
  We've gone over most of these, but you can find a full description in <RouterLink to="/object-basics">§Object Basics</RouterLink>
</p>

<h2>
  Editing and Deleting a Message
</h2>

<p>
  You can edit and delete your own messages but, importantly <strong>you can't edit or delete other people's messages</strong>.
  To edit your own message, you can simply modify the message object and the change will sync to the server.
  To delete your own message, you can call <code class="language-js">delete</code> on the message object's ID property.
  Try it out:
</p>

<GraffitiPlayground path="edit-message" :data="{id: ''}"/>

<h2>
  Annotating a Message
</h2>

<p>
  Many chat applications have features where you can annotate messages either you or other people have made. For example, in Messenger you can "like" someone else's message and in most Email clients you can add tags to emails you've received.
  Commenting can also be seen as a form of annotation.
</p>

<p>
  Since you can't modify or delete other people's messages, annotations are actually <em>additional</em> objects that "point" to the messages they're annotating.
</p>

<p>
  In the example below we add a button to like messages.
  We're making it an ActivityStreams <a href="https://www.w3.org/TR/activitystreams-vocabulary/#dfn-like">Like</a>,
  which has a <code class="language-js">type</code> of <code class="language-js">'Like'</code> and
  a property <code class="language-js">object</code> which references the object we're liking, in this case it is the message's ID.
</p>

<p>
  Creating and viewing the likes should look similar to sending and receiving messages.
  The only difference is the "context".
  In this case we're not putting the likes in our recipient's "inbox" we're putting the likes in the message's "inbox".
  Again, you can learn more about context in <RouterLink to="/context">§Context</RouterLink>.
</p>

<p>
  We're also taking advantage of some shorthand functions in the controls
  <code class="language-js">likes.mine</code> filters the likes array for objects that you created,
  <code class="language-js">likes.removeMine()</code> removes all your objects that exist in the array,
  and <code class="language-js">likes.actors</code> reduces the array to an array of the unique actors with elements in the array (we're using this so that one person's like isn't counted more than once).
</p>

<GraffitiPlayground path="like" :data="{messageID: ''}"/>

<p>
  To make comments you could use an ActivityStreams Note with an <a href="https://www.w3.org/TR/activitystreams-vocabulary/#dfn-inreplyto">inReplyTo</a> property.
  To add read reciepts you could use an ActivityStreams <a href="https://www.w3.org/TR/activitystreams-vocabulary/#dfn-read">Read</a> object.
</p>

<h2>
  Chat Rooms
</h2>

<p>
  TODO
  <!--Oftentimes chat applications offer chat "rooms" or "channels".-->
  <!--When someone is added to a room they can see that room's entire message history.-->
  <!--In Graffiti access to an object is assigned per-object.-->
</p>
