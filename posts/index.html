<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>posts</title>
  <link rel="stylesheet" href="./style.css">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
  <div id="app">
    <graffiti-collection v-slot="posts" :query="{
      type: 'post',
      content: { $type: 'string' }
    }">
      <template v-if="!$graffiti.loggedIn">
        <button @click="$graffiti.logIn">log in to post!</button>
      </template>
      <template v-else>
        <input v-model="content">
        <button @click="posts.update({
          type: 'post',
          timestamp: Date.now(),
          content: content
        });content=''">
          post!
        </button>
        <p>(<a href="" @click.prevent="$graffiti.logOut">log out</a>)</p>
      </template>

      <ul>
        <li v-for="post in posts.objects" :key="post._id">
          <graffiti-collection v-slot="likes" :query="{
            type: 'like',
            at: post._id,
            _by: { $type: 'string' }
          }">
            "{{post.content}}" has
            {{likes.objects.length}} likes.
            <template v-if="$graffiti.loggedIn">
              <template v-if="!likes.objects.map(l=>l._by).includes($graffiti.myID)">
                <a href="" @click.prevent="likes.update({
                  type: 'like',
                  at: post._id,
                  _by: $graffiti.myID
                })">like</a>
              </template>
              <template v-else>
                <a href="" @click.prevent="likes.delete(
                  likes.objects.find(l=>l._by==$graffiti.myID)._id
                )">unlike</a>
              </template>
            </template>
          </graffiti-collection>
        </li>
      </ul>
    <graffiti-collection>
  </div>
  <script type="module">
    import { createApp } from "https://unpkg.com/vue@3.2.36/dist/vue.esm-browser.prod.js"
    import Graffiti from "../vue/plugin.js"
    Graffiti().then(g=>createApp({
      data() {
        return {
          content: ""
        }
      }
    }).use(g).mount("#app"))
  </script>
</body>
</html>
